<!doctype html>
<html>
  <head>
    <title>Tron</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        overflow:hidden;
      }
      #content {
        text-align:center;
        
      }
      #controls {
        position: absolute;
        display: block;
      }
      #start {
        background: blue;
      }
      #onScreen {
        position:relative;
        bottom:70vh;
        font-size:450%;
        text-align:center;
        z-index:1;
      }
    </style>
  </head>
  <body>
    <div id="controls">
      <div>
        
      </div>
    </div>
    <div id="content">
      <canvas id="game"></canvas>
      <h1 id="onScreen"></h1>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      $(function(){
        var socket = io();
        var canvas = document.getElementById("game");
        canvas.width = window.innerHeight;
        canvas.height = window.innerHeight;
        var ctx = canvas.getContext("2d");
        var size = canvas.height;
        var x = size / 2,
          y = size / 2,
          dir = "UP",
          speed = scale(4),
          trailSize = scale(3),
          colorList = ['#FF0000' , '#800000' , '#FFFF00' , '#808000' ,
                 '#00FF00' , '#008000' , '#00FFFF' , '#0000FF' , 
                 '#000080' , '#FF00FF' , '#800080'],
          color,
          spectator = false;
        
        socket.on('connect', function(){
          socket.emit('newconnection');
        });
        
        socket.on('setup', function(c, index, status){
          if (status == "playing") {
            color = c;
            x = scale((index+1)*100);
            y = canvas.height/2;
            $('#onScreen').text('Player');
            setTimeout(function(){
              $('#onScreen').text('');
            }, 1000);
          } else {
            spectator = true;
            $('#onScreen').text('Spectator');
            setTimeout(function(){
              $('#onScreen').text('');
            }, 1000);
          }
        });
        
        function startGame(){
          socket.emit('startgame');
        }
        
        socket.on('start', function(){
          var count = 5;
          if (!spectator) {
            socket.emit('movement', x, y, color);
          }
          var counting = setInterval(function(){
            $('#onScreen').text(count);
            count-=1;
            if (count < -1){
              clearInterval(counting);
              $('#onScreen').text('Go!');
              setTimeout(function(){
                $('#onScreen').text('');
                if (!spectator) {
                  start();
                }
              }, 500);
            }
          }, 1000);
        });
        
        socket.on('move', function(nX,nY,nC){
          ctx.fillStyle = nC;
          ctx.beginPath();
          ctx.arc(scale(nX), scale(nY), trailSize, 0, 2 * Math.PI, true);
          ctx.closePath();
          ctx.fill();
        });
        
        ctx.fillStyle = "#303030";
        ctx.fillRect(0, 0, size, size);
        trailSize*=2.5;
        function start(){
          var playing = setInterval(run, 30);
        }
        
        function run() {
          //movement
          switch (dir) {
            case "UP":
              y -= speed;
              break;
            case "RIGHT":
              x += speed;
              break;
            case "DOWN":
              y += speed;
              break;
            case "LEFT":
              x -= speed;
              break;
          }
          socket.emit('movement', x, y, color);
          //collisions
          collisionCheck();
        }

        function turn(turnDir) {
          if (turnDir == "UP" && dir != "DOWN") {
            dir = "UP";
          } else if (turnDir == "RIGHT" && dir != "LEFT") {
            dir = "RIGHT";
          } else if (turnDir == "DOWN" && dir != "UP") {
            dir = "DOWN";
          } else if (turnDir == "LEFT" && dir != "RIGHT") {
            dir = "LEFT";
          }
        }

        function collisionCheck() {
          var cMap;
          switch (dir) {
            case "UP":
              cMap = ctx.getImageData(x - trailSize / 2, y - trailSize / 2 - 1, trailSize, 1).data;
              break;
            case "RIGHT":
              cMap = ctx.getImageData(x + trailSize / 2 + 1, y - trailSize/2, 1, trailSize).data;
              break;
            case "DOWN":
              cMap = ctx.getImageData(x - trailSize / 2, y + trailSize / 2 + 1, trailSize, 1).data;
              break;
            case "LEFT":
              cMap = ctx.getImageData(x - trailSize / 2 - 1, y - trailSize/2, 1, trailSize).data;
              break;
          }
          if (x < 0 || x > size || y < 0 || y > size) {
            die();
          } else {
            for (var i = 0; i < colors.length; i++) {
              if (colors[i] == rgbToHex(cMap[0], cMap[1], cMap[2])) {
                die();
                break;
              }
            }
          }
        }

        function die() {
          clearInterval(playing);
          console.log("dead");
        }
        
        document.addEventListener("keydown", keyHandler, false);
        function keyHandler(key) {
          console.log("i made it");
          switch (key.keyCode) {
            case 38:
              turn("UP");
              break;
            case 39:
              turn("RIGHT");
              break;
            case 40:
              turn("DOWN");
              break;
            case 37:
              turn("LEFT");
              break;
            case 13:
              startGame();
              break;
          }
        }
        
        //various utilities I needed
        function rgbToHex(red, green, blue) {
          var rgb = blue | (green << 8) | (red << 16);
          return '#' + (0x1000000 + rgb).toString(16).slice(1);
        }
        
        function scale(num){
          var standard = 605;
          return canvas.height/((standard)/num);
        }

        function reset(){
          dir = "UP";
          x = size/2;
          y = size/2;
          ctx.fillStyle = "#303030";
          ctx.fillRect(0, 0, size, size);
        }
      });

    </script>
  </body>
</html>